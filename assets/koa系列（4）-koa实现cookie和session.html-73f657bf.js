import{_ as o,r as p,o as i,c,a as s,b as n,d as e,e as t}from"./app-00a966d3.js";const l={},r=s("h1",{id:"koa2使用cookie",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#koa2使用cookie","aria-hidden":"true"},"#"),n(" koa2使用cookie")],-1),u=s("h2",{id:"使用方法",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#使用方法","aria-hidden":"true"},"#"),n(" 使用方法")],-1),k=s("p",null,"koa提供了从上下文直接读取、写入cookie的方法",-1),d=s("ul",null,[s("li",null,"ctx.cookies.get(name, [options]) 读取上下文请求中的cookie"),s("li",null,"ctx.cookies.set(name, value, [options]) 在上下文中写入cookie")],-1),v={href:"https://github.com/pillarjs/cookies",target:"_blank",rel:"noopener noreferrer"},m=t(`<h2 id="例子代码" tabindex="-1"><a class="header-anchor" href="#例子代码" aria-hidden="true">#</a> 例子代码</h2><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;koa&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span> <span class="token keyword">async</span> <span class="token punctuation">(</span> <span class="token parameter">ctx</span> <span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span> ctx<span class="token punctuation">.</span>url <span class="token operator">===</span> <span class="token string">&#39;/index&#39;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>
      <span class="token string">&#39;cid&#39;</span><span class="token punctuation">,</span> 
      <span class="token string">&#39;hello world&#39;</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token literal-property property">domain</span><span class="token operator">:</span> <span class="token string">&#39;localhost&#39;</span><span class="token punctuation">,</span>  <span class="token comment">// 写cookie所在的域名</span>
        <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">&#39;/index&#39;</span><span class="token punctuation">,</span>       <span class="token comment">// 写cookie所在的路径</span>
        <span class="token literal-property property">maxAge</span><span class="token operator">:</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token comment">// cookie有效时长</span>
        <span class="token literal-property property">expires</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token string">&#39;2017-02-15&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// cookie失效时间</span>
        <span class="token literal-property property">httpOnly</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>  <span class="token comment">// 是否只用于http请求中获取</span>
        <span class="token literal-property property">overwrite</span><span class="token operator">:</span> <span class="token boolean">false</span>  <span class="token comment">// 是否允许重写</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">&#39;cookie is ok&#39;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">&#39;hello world&#39;</span> 
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;[demo] cookie is starting at port 3000&#39;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>


</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="运行例子" tabindex="-1"><a class="header-anchor" href="#运行例子" aria-hidden="true">#</a> 运行例子</h2><h3 id="执行脚本" tabindex="-1"><a class="header-anchor" href="#执行脚本" aria-hidden="true">#</a> 执行脚本</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">node</span> index.js
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="运行结果" tabindex="-1"><a class="header-anchor" href="#运行结果" aria-hidden="true">#</a> 运行结果</h3>`,6),h={id:"访问http-localhost-3000-index",tabindex:"-1"},b=s("a",{class:"header-anchor",href:"#访问http-localhost-3000-index","aria-hidden":"true"},"#",-1),y={href:"http://localhost:3000/index",target:"_blank",rel:"noopener noreferrer"},g=t('<ul><li>可以在控制台的cookie列表中中看到写在页面上的cookie</li><li>在控制台的console中使用document.cookie可以打印出在页面的所有cookie（需要是httpOnly设置false才能显示）</li></ul><p><img src="https://s2.loli.net/2022/06/18/jDM7ki51dLeF4Hc.png" alt="cookie-result-01.png"></p><h1 id="koa2实现session" tabindex="-1"><a class="header-anchor" href="#koa2实现session" aria-hidden="true">#</a> koa2实现session</h1><h2 id="前言" tabindex="-1"><a class="header-anchor" href="#前言" aria-hidden="true">#</a> 前言</h2><p>koa2原生功能只提供了cookie的操作，但是没有提供session操作。session就只用自己实现或者通过第三方中间件实现。在koa2中实现session的方案有一下几种</p><ul><li>如果session数据量很小，可以直接存在内存中</li><li>如果session数据量很大，则需要存储介质存放session数据</li></ul><h2 id="数据库存储方案" tabindex="-1"><a class="header-anchor" href="#数据库存储方案" aria-hidden="true">#</a> 数据库存储方案</h2><ul><li>将session存放在MySQL数据库中</li><li>需要用到中间件 <ul><li>koa-session-minimal 适用于koa2 的session中间件，提供存储介质的读写接口 。</li><li>koa-mysql-session 为koa-session-minimal中间件提供MySQL数据库的session数据读写操作。</li><li>将sessionId和对应的数据存到数据库</li></ul></li><li>将数据库的存储的sessionId存到页面的cookie中</li><li>根据cookie的sessionId去获取对于的session信息</li></ul><h2 id="快速使用" tabindex="-1"><a class="header-anchor" href="#快速使用" aria-hidden="true">#</a> 快速使用</h2><p>demo源码</p>',10),_={href:"https://github.com/ChenShenhai/koa2-note/blob/master/demo/session/index.js",target:"_blank",rel:"noopener noreferrer"},f=t(`<h3 id="例子代码-1" tabindex="-1"><a class="header-anchor" href="#例子代码-1" aria-hidden="true">#</a> 例子代码</h3><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;koa&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> session <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;koa-session-minimal&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> MysqlSession <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;koa-mysql-session&#39;</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 配置存储session信息的mysql</span>
<span class="token keyword">let</span> store <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MysqlSession</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">user</span><span class="token operator">:</span> <span class="token string">&#39;root&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">password</span><span class="token operator">:</span> <span class="token string">&#39;abc123&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">database</span><span class="token operator">:</span> <span class="token string">&#39;koa_demo&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">host</span><span class="token operator">:</span> <span class="token string">&#39;127.0.0.1&#39;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 存放sessionId的cookie配置</span>
<span class="token keyword">let</span> cookie <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">maxAge</span><span class="token operator">:</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">,</span> <span class="token comment">// cookie有效时长</span>
  <span class="token literal-property property">expires</span><span class="token operator">:</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">,</span>  <span class="token comment">// cookie失效时间</span>
  <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">,</span> <span class="token comment">// 写cookie所在的路径</span>
  <span class="token literal-property property">domain</span><span class="token operator">:</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">,</span> <span class="token comment">// 写cookie所在的域名</span>
  <span class="token literal-property property">httpOnly</span><span class="token operator">:</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">,</span> <span class="token comment">// 是否只用于http请求中获取</span>
  <span class="token literal-property property">overwrite</span><span class="token operator">:</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">,</span>  <span class="token comment">// 是否允许重写</span>
  <span class="token literal-property property">secure</span><span class="token operator">:</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">sameSite</span><span class="token operator">:</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">signed</span><span class="token operator">:</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">,</span>
  
<span class="token punctuation">}</span>

<span class="token comment">// 使用session中间件</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">session</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token string">&#39;SESSION_ID&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">store</span><span class="token operator">:</span> store<span class="token punctuation">,</span>
  <span class="token literal-property property">cookie</span><span class="token operator">:</span> cookie
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span> <span class="token keyword">async</span> <span class="token punctuation">(</span> <span class="token parameter">ctx</span> <span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

  <span class="token comment">// 设置session</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> ctx<span class="token punctuation">.</span>url <span class="token operator">===</span> <span class="token string">&#39;/set&#39;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>session <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">user_id</span><span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">count</span><span class="token operator">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> ctx<span class="token punctuation">.</span>session
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> ctx<span class="token punctuation">.</span>url <span class="token operator">===</span> <span class="token string">&#39;/&#39;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// 读取session信息</span>
    ctx<span class="token punctuation">.</span>session<span class="token punctuation">.</span>count <span class="token operator">=</span> ctx<span class="token punctuation">.</span>session<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> ctx<span class="token punctuation">.</span>session
  <span class="token punctuation">}</span> 
  
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;[demo] session is starting at port 3000&#39;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="运行例子-1" tabindex="-1"><a class="header-anchor" href="#运行例子-1" aria-hidden="true">#</a> 运行例子</h3><h4 id="执行命令" tabindex="-1"><a class="header-anchor" href="#执行命令" aria-hidden="true">#</a> 执行命令</h4><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">node</span> index.js
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="访问连接设置session" tabindex="-1"><a class="header-anchor" href="#访问连接设置session" aria-hidden="true">#</a> 访问连接设置session</h4>`,6),x={href:"http://localhost:3000/set",target:"_blank",rel:"noopener noreferrer"},w=s("img",{src:"https://s2.loli.net/2022/06/18/HCWcUeikJONY387.png",alt:"session-result-01.png"},null,-1),j=t('<h4 id="查看数据库session是否存储" tabindex="-1"><a class="header-anchor" href="#查看数据库session是否存储" aria-hidden="true">#</a> 查看数据库session是否存储</h4><p><img src="https://s2.loli.net/2022/06/18/lysX8VKS36L19WF.png" alt="session-result-03.png"></p><h4 id="查看cookie中是否种下了sessionid" tabindex="-1"><a class="header-anchor" href="#查看cookie中是否种下了sessionid" aria-hidden="true">#</a> 查看cookie中是否种下了sessionId</h4>',3),S={href:"http://localhost:3000",target:"_blank",rel:"noopener noreferrer"},q=s("img",{src:"https://s2.loli.net/2022/06/18/fWGwdV1j3pJmqUT.png",alt:"session-result-02.png"},null,-1);function I(K,L){const a=p("ExternalLinkIcon");return i(),c("div",null,[r,u,k,d,s("p",null,[n("koa2 中操作的cookies是使用了npm的cookies模块，源码在"),s("a",v,[n("https://github.com/pillarjs/cookies"),e(a)]),n("，所以在读写cookie的使用参数与该模块的使用一致。")]),m,s("h4",h,[b,n(" 访问"),s("a",y,[n("http://localhost:3000/index"),e(a)])]),g,s("p",null,[s("a",_,[n("https://github.com/ChenShenhai/koa2-note/blob/master/demo/session/index.js"),e(a)])]),f,s("p",null,[s("a",x,[n("http://localhost:3000/set"),e(a)]),w]),j,s("p",null,[s("a",S,[n("http://localhost:3000"),e(a)]),q])])}const N=o(l,[["render",I],["__file","koa系列（4）-koa实现cookie和session.html.vue"]]);export{N as default};
